===========
TDT backend
===========

Hardware
========

TDT equipment
-------------

RZ5_
    Used primarily for data acquisition, 4 ADC, 4 DAC and 16 TTL (input or
    output)
RX6_
    Used primarily for stimulus output (audio), 2 ADC, 2 DAC and 16 TTL (input
    or output)
PA5_
    Programmable attenuator (control sound level)
RPvds_
    Schema design tool for FPGA module in TDT devices

The RZ6 and RX6 are essentially FPGA units.  RPvds allows us to create circuit
schemas that are compiled and uploaded to the FGPA chip inside the RZ5 and RX6.
The RZ5/RX6 environments provide a limited amount of RAM memory (to buffer data
for analysis and transfer to the computer) The RX6 is primarily responsible for
playing the audio signal and generating the necessary TTLs for controlling the
timing of other hardware devices.

Audio sounds are generated by uploading segments of a waveform (generated by the
computer) to a buffer (accessed via the FPGA).  These segments are played out in
succession to one of DACs.  This DAC is connected to an attenuator/amplifier
series that drives the speaker.  Since we utilize auditory stimuli up to 50 kHz,
we need to run the RX6 unit at ~100 kHz (the Nyquist frequency).  Thus, the
waveform must be generated with an identical sampling frequency (~100 kHz).
This is a raw waveform (e.g. a point-by-point value representing the actual
voltage on the DAC on each "tick" of the FPGA clock).  Each point is a 32-bit
float, meaning that the RX6 consumes ~0.4 MB/s when playing out to a single
speaker.  The interface between the RX6 and the computer can support write
speeds of 1.0 MB/s.  However, if I am currently running an experiment with a 5
second waveform, a single waveform is 2 MB in size.  Each time I change a
parameter in the GUI, this means that we must update the FPGA buffer with the
new waveform.  At the FPGA's maximum transfer rate, this means it takes 2
seconds to upload the entire waveform.

Additional supplies needed
--------------------------

Breakout BNC female cable
    501-1030-ND from DigiKey_

Cree XR-E (DigiKey_) - 2
    DigKey has a fairly large selection of emitters.  To narrow down the
    selection, restrict your search to those currently in-stock with a minimum
    order quantity of 1.  You want one that can take at least 700 mA.  They come
    in various colors (we use soft/warm white).
Optical sensor
    365-1085-ND (Optek OP950) 935 nm side photodiode
    160-1063-ND (Lite-On LTE-302) 940 nm IR emitter
Air puff
    Pipe adapter 1/8" NPT x 1/4" ID (Cole-Parmer Part #A2-4NP)
    PVC braided tubing 1/4" ID x 7/16" OD x 3/32" wall (Nalgene Part #8005-0070)
    Solenoid air control valve 1/8" port (ARO Model #P251SS-012-D via DrillSpot_)

.. _DigiKey: http://digikey.com .. _DrillSpot: http://www.drillspot.com


Connections
===========

Digital
-------

Using a DB-25 (i.e. printer cable), connect the DB-25 port on the RX6 to the
DB-25 port on the PP24.  The PP24 has 24 BNCs labelled A1-C8.

========= ======== ======= ============ ==============================
RX6 ID    Bit Mask PP24 ID Connection   Signal
========= ======== ======= ============ ==============================
Bit 0     1        A1      OUT          Sync Trigger
Bit 1     2        A2      IN           
Bit 2     4        A3      OUT          
Bit 3     8        A4      IN           
Bit 4     16       A5      OUT          
Bit 5     32       A6      IN           
Bit 6     64       A7      OUT          Pump trigger
Bit 7     128      A8      OUT          120 VAC relay

Word 1.*  255                           15 for 0-3 bitmask
Word 1.0  1        B1      OUT 5V       Info light (Cree XR with 1 k |ohm| resistor) [#]_
Word 1.1  2        B2      OUT 12V      Bright light (Cree XR with 10 |ohm| resistor)
Word 1.2  4        B3      OUT 12V      Air puff (pneumatic solenoid)
Word 1.3  8        B4      OUT          Shock trigger
Word 1.4  16       B5      OUT        
Word 1.5  32       B6      OUT         
Word 1.6  64       B7      OUT        
Word 1.7  128      B8      OUT         

Word 2.*  65280                         3840 for 0-3 bitmask
Word 2.0  256      C1      IN E-ADC     Electrical sensor 1 [#]_
Word 2.1  512      C2      IN E-ADC     Electrical sensor 2 [#]_
Word 2.2  1024     C3      IN O-ADC     Optical sensor 1
Word 2.3  2048     C4      IN O-ADC     Optical sensor 2
Word 2.4  4096     C5      IN       
Word 2.5  8192     C6      IN        
Word 2.6  16384    C7      IN       
Word 2.7  32768    C8      IN        
========= ======== ======= ============ ==============================

.. [#] Pass throught the power relay and set toggle switch to specified voltage.
.. [#] Pass through analog to TTL converter for electrical sensor.
.. [#] Pass output of photosensor through the analog to TTL converter for
       optical sensor.  Be sure to connect the power supply for the LED (on the
       back) to the emitter.

.. |ohm| unicode:: U+003A9  

Synchronizing IO
================

Due to inherent limitations in input/output channels, there is some delay in the
process of converting from digital to analog and vice versa that must be
accounted for.

========= =====
Type      Delay
========= =====
TTL DAC   2
TTL ADC   2
DAC       43
ADC       70
========= =====

.. _RZ5: http://www.tdt.com/products/RZ5.htm
.. _RX6: http://www.tdt.com/products/RX6.htm
.. _PA5: http://www.tdt.com/products/PA5.htm
.. _RPvds: http://www.tdt.com/software/rpvds.htm

The API
=======

.. automodule:: cns.equipment.TDT.rpcox
    :members:
