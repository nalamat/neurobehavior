

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Interfacing with the equipment &mdash; NeuroBehavior v0.3 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="NeuroBehavior v0.3 documentation" href="index.html" />
    <link rel="prev" title="Welcome to NeuroBehavior’s documentation!" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to NeuroBehavior’s documentation!"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">NeuroBehavior v0.3 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-cns.equipment">
<span id="interfacing-with-the-equipment"></span><h1>Interfacing with the equipment<a class="headerlink" href="#module-cns.equipment" title="Permalink to this headline">¶</a></h1>
<p>Primary interface to the equipment (e.g. DSP, pump, attenuator).  This is meant
to be the first step in the &#8220;abstraction layer&#8221;.  Since the libraries are meant
to be usable on computers that may not have all the necessary equipment drivers
installed, the equipment modules are only loaded when requested.</p>
<div class="section" id="dsp-hardware">
<h2>DSP hardware<a class="headerlink" href="#dsp-hardware" title="Permalink to this headline">¶</a></h2>
<p>Right now only one DSP backend (TDT) is supported.  A backend module deals with
the hardware and driver-specific implementation details.  For example, to read
from a buffer on a TDT DSP device without using the backend:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">cns.equipment.TDT.actxobjects</span> <span class="kn">import</span> <span class="n">RX6</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">RX6</span><span class="o">.</span><span class="n">ConnectRX6</span><span class="p">(</span><span class="s">&#39;GB&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">RX6</span><span class="o">.</span><span class="n">ClearCOF</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">RX6</span><span class="o">.</span><span class="n">LoadCOF</span><span class="p">(</span><span class="s">&#39;aversive-behavior.rcx&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">RX6</span><span class="o">.</span><span class="n">Start</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">last_read_index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">next_index</span> <span class="o">=</span> <span class="n">RX6</span><span class="o">.</span><span class="n">GetTagVal</span><span class="p">(</span><span class="s">&#39;contact_buf_idx&#39;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">next_index</span> <span class="o">&gt;</span> <span class="n">last_read_index</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">length</span> <span class="o">=</span> <span class="n">next_index</span> <span class="o">-</span> <span class="n">last_read_index</span>
<span class="gp">... </span>        <span class="n">data</span> <span class="o">=</span> <span class="n">RX6</span><span class="o">.</span><span class="n">ReadTagV</span><span class="p">(</span><span class="s">&#39;contact_buf&#39;</span><span class="p">,</span> <span class="n">last_read_index</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">elif</span> <span class="n">next_index</span> <span class="o">&lt;</span> <span class="n">last_read_index</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">length_a</span> <span class="o">=</span> <span class="n">RX6</span><span class="o">.</span><span class="n">GetTagSize</span><span class="p">(</span><span class="s">&#39;contact_buf&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">last_read_index</span>
<span class="gp">... </span>        <span class="n">data_a</span> <span class="o">=</span> <span class="n">RX6</span><span class="o">.</span><span class="n">ReadTagV</span><span class="p">(</span><span class="s">&#39;contact_buf&#39;</span><span class="p">,</span> <span class="n">last_read_index</span><span class="p">,</span> <span class="n">length_a</span><span class="p">)</span>
<span class="gp">... </span>        <span class="n">data_b</span> <span class="o">=</span> <span class="n">RX6</span><span class="o">.</span><span class="n">ReadTagV</span><span class="p">(</span><span class="s">&#39;contact_buf&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">next_index</span><span class="p">)</span>
<span class="gp">... </span>        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data_a</span><span class="p">,</span> <span class="n">data_b</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">last_read_index</span> <span class="o">=</span> <span class="n">next_index</span>
</pre></div>
</div>
<p>Phew!  That was a lot of boilerplate code just to load a circuit, run it, and
continously read any new data in the contact buffer.  You have to continuously
track the last index you read, check to see if the buffer has wrapped around to
the beginning, and acquire the data.  Wouldn&#8217;t it be easier to just write:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">cns</span> <span class="kn">import</span> <span class="n">equipment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">circuit</span> <span class="o">=</span> <span class="n">equipment</span><span class="o">.</span><span class="n">dsp</span><span class="p">(</span><span class="s">&#39;TDT&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;aversive-behavior&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">circuit</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">data</span> <span class="o">=</span> <span class="n">circuit</span><span class="o">.</span><span class="n">contact_buf</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
</pre></div>
</div>
<p>This is precisely how the backend works.  All the hardware-specific
implementation details of how to access the DSP variables (e.g.
contact_buf_idx), determine the buffer size, and read data from the buffer are
handled by <cite>DSPBuffer.read</cite> in the TDT module.  It gets even better.  Let&#8217;s say
you decide you want to go with National Instruments instead.  Hopefully at some
point, someone has written a backend module for National Instruments (presumably
it would live in the NI module).  In this module there would be a
<cite>DSPBuffer.read</cite> method that knows how to deal with the NI DSP. The only change
you would need to make to your code is to tell it to load the NI module rather
than the TDT module.</p>
<p>The call to <cite>equipment.dsp()</cite> will load the appropriate backend driver depending
on what&#8217;s available.  Since each backend driver is expected to follow a set API,
your code should not need to worry about backend-specific implementation details
as long as you restrict yourself to the API.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The mechanism for specifying the backend has not really been fleshed
out (since we only have one supported backend).  Right now you have to
specify it in the <cite>equipment.dsp</cite> method (it currently defaults to the only
suported backend, TDT).  However, we could conceivably have a settings file
for the program that a user can edit to specify the backend, or use an
environment variable.  Once we need to start supporting additional backends
(e.g. National Instruments or Neurolarynx), we will have to put some thought
into the mechanism for loading multiple backends.</p>
</div>
</div>
<div class="section" id="pump-hardware">
<h2>Pump hardware<a class="headerlink" href="#pump-hardware" title="Permalink to this headline">¶</a></h2>
<p>Right now only one pump (New Era) is supported.  I&#8217;m going to briefly expand on
how the API abstraction layer is expected to work.  New Era requires a RS-232
cable to communicate with the computer, along with some pretty arcane syntax.
If we wanted to set the infusion rate on the pump, we would need to:</p>
<blockquote>
1. Know how to initialize the serial port, set it&#8217;s baud rate, and close it
properly at program exit.
2. Remember the manufacturer-specific command syntax for setting the rate.
In this case it&#8217;s &#8220;RAT 0.300 MM&lt;CR&gt;&#8221;.
3. Know how to parse the pump&#8217;s response (which conveys information about
the status of the pump).</blockquote>
<p>So, we&#8217;d need to do:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">serial</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pump</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">connection_settings</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pump</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;RAT 0.300 MM</span>
<span class="go">&quot;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">pump</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">eol</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Result is typically an arcane string along the lines of &#8220;01I?&#8221;.  This string
contains a single letter that indicates the status of the pump.  If the string
indicates there is an error, this needs to be converted into something the
Python exception machinery can handle.  We can typically determine what the
error is by inspecting the response string (e.g. a &#8216;S&#8217; indicates the pump motor
is stalled) and raising a PumpHardwareError exception that displays a message
that the user can understand.</p>
<p>So, how do we use the API?</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">cns</span> <span class="kn">import</span> <span class="n">equipment</span> <span class="c"># see a pattern here?</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pump</span> <span class="o">=</span> <span class="n">equipment</span><span class="o">.</span><span class="n">pump</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pump</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mf">0.3</span>
</pre></div>
</div>
<p>Better yet, wrap it in a try/except block.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">cns</span> <span class="kn">import</span> <span class="n">equipment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">try</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">pump</span> <span class="o">=</span> <span class="n">equipment</span><span class="o">.</span><span class="n">pump</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">pump</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">except</span> <span class="n">PumpCommError</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="s">&#39;Cannot connect to pump.  Is it turned on?&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">except</span> <span class="n">PumpHardwareError</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="s">&#39;Able to connect to pump, but there is a hardware problem.&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Note that <cite>PumpCommError</cite> and <cite>PumpHardwareError</cite> are subclasses of
<cite>PumpError</cite>.  In turn, <cite>PumpError</cite> is a subclass of <cite>EquipmentError</cite>.  Both
have subclass-specific error messages.  These error messages should be quite
informative and contain information to help the user solve the problem (e.g.
could they have forgotten to turn on something or is a cable disconnected?).
If the error message isn&#8217;t very informative, this is considered a BUG and
should be reported accordingly.  So you could simply do:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">cns</span> <span class="kn">import</span> <span class="n">equipment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">try</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">pump</span> <span class="o">=</span> <span class="n">equipment</span><span class="o">.</span><span class="n">pump</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">pump</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">except</span> <span class="n">EquipmentError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">e</span>
</pre></div>
</div>
</div>
</div>
<span class="target" id="module-cns.equipment.new_era"></span><div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This file contains four key classes that work together:</p>
<blockquote>
<dl class="docutils">
<dt>PumpInterface</dt>
<dd>Handles communication with the pump hardware (e.g. changing rate,
querying volume dispensed, determining whether there&#8217;s an error).  This
is the abstraction layer.</dd>
<dt>PumpController</dt>
<dd>Contains logic for responding to user interaction (e.g.  what should
happen when the &#8220;override&#8221; button is pressed?).  This should be able to
work with any abstraction layer.</dd>
<dt>pump_view</dt>
<dd>What information should the GUI have and how should it look?</dd>
<dt>Pump</dt>
<dd>The settings for the pump.</dd>
<dt>PumpError</dt>
<dd>A generic pump error.</dd>
</dl>
</blockquote>
<p>If all you care about is controlling the pump via the python shell interface or
via your program, <cite>PumpInterface</cite> is the only class you need.  You can simply
load it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">cns</span> <span class="kn">import</span> <span class="n">equipment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pump_backend</span> <span class="o">=</span> <span class="n">equipment</span><span class="o">.</span><span class="n">pump</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pump</span> <span class="o">=</span> <span class="n">pump_backend</span><span class="o">.</span><span class="n">PumpInterface</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="generating-a-gui">
<h2>Generating a GUI<a class="headerlink" href="#generating-a-gui" title="Permalink to this headline">¶</a></h2>
<p>However, if you want help presenting a GUI that allows the user to interact with
the pump, then the other three classes come into play.  You might be wondering
how the <cite>PumpController</cite> differs from the <cite>PumpInterface</cite>.  While we could
certainly combine these two classes into a single, monolithic class, I view
these classes as serving two very different functions.  The <cite>PumpInterface</cite>
class is hardware-specific.  That is, it knows how to communicate with the pump
itself.  The <cite>PumpController</cite> is hardware-independent.  You simply tell the
<cite>PumpController</cite> which interface to use (right now this defaults to the New Era
pump interface).  The <cite>PumpController</cite> monitors the pump (via the PumpInterface)
and tells the PumpInterface what to do in response to changes in the GUI.</p>
<p>By splitting out functionality like this, we can swap in a different class if we
want the behavior to be different.  For example, we can use a different
<cite>pump_view</cite> class to change how the GUI looks.  If we don&#8217;t like how the current
&#8220;handler/controller&#8221; (which determines what commands to send to the pump
interface based on user input), we can write a different handler.  Finally, a
new PumpInterface can be written if we ever use a pump from a different
manufacturer.</p>
<dl class="docutils">
<dt>pump_view &lt;-&gt; PumpController &lt;-&gt; Pump</dt>
<dd>PumpInterface</dd>
</dl>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Interfacing with the equipment</a><ul>
<li><a class="reference internal" href="#dsp-hardware">DSP hardware</a></li>
<li><a class="reference internal" href="#pump-hardware">Pump hardware</a></li>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#generating-a-gui">Generating a GUI</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Welcome to NeuroBehavior&#8217;s documentation!</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/equipment.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to NeuroBehavior’s documentation!"
             >previous</a> |</li>
        <li><a href="index.html">NeuroBehavior v0.3 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010, Brad Buran.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.3.
    </div>
  </body>
</html>